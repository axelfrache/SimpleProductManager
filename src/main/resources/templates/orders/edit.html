<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>Edit Order</h1>
<form th:action="@{/orders}" th:object="${command}" method="post">
    <input type="hidden" th:field="*{id}">
    <div class="mb-3">
        <label for="client" class="form-label">Client:</label>
        <select id="client" name="clientId" class="form-select" required>
            <option value="">Select a client...</option>
            <option th:each="client : ${clients}" th:value="${client.id}" th:text="${client.firstName + ' ' + client.lastName}"></option>
        </select>
    </div>
    <div id="productsSection" class="mb-3">
        <label for="products" class="form-label">Products and Quantities:</label>
        <div id="productRows">
            <th:block th:each="commandProduct : ${command.commandProducts}">
                <div class="row mb-2">
                    <div class="col">
                        <select name="products[]" class="form-select" required>
                            <option th:selected="${commandProduct.product.id == option.id}"
                                    th:each="option : ${productsOptions}"
                                    th:value="${option.id}"
                                    th:text="${option.name}"></option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="number" name="quantities[]" min="1" class="form-control"
                               th:value="${commandProduct.quantity}" required/>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-danger" onclick="removeProductRow(this)">Remove</button>
                    </div>
                </div>
            </th:block>
        </div>
        <template id="productRowFragment">
        </template>
        <button type="button" class="btn btn-success" th:unless="${command.id != null}" onclick="addProductRow()">Add Product</button>
    </div>

    <template id="productRowFragment">
    </template>
    <button type="submit" class="btn btn-primary">Save</button>
    <a href="/orders" class="btn btn-secondary">Cancel</a>
</form>

<script th:inline="javascript">
    var productsOptions = JSON.parse(/*[[${productOptions}]]*/ '{}');

    window.onload = function() {
        var addProductButton = document.getElementById('productsSection').querySelector('button.btn-success');
        if (addProductButton) {
            addProductButton.addEventListener('click', addProductRow); // Add event listener if button exists
        }
    };

    function addProductRow() {
        var div = document.createElement('div');
        div.className = 'row mb-2';
        var selectHTML = '<select name="products[]" class="form-select">';
        Object.entries(productsOptions).forEach(([id, name]) => {
            selectHTML += `<option value="${id}">${name}</option>`;
        });
        selectHTML += '</select>';
        div.innerHTML = `
            <div class="col">
                ${selectHTML}
            </div>
            <div class="col">
                <input type="number" name="quantities[]" min="1" value="1" class="form-control"/>
            </div>
            <div class="col">
                <button type="button" class="btn btn-danger" onclick="removeProductRow(this)">Remove</button>
            </div>
        `;
        document.getElementById('productRows').appendChild(div);
    }

    function removeProductRow(button) {
        button.closest('.row').remove();
    }
</script>

</body>
</html>
